<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
          <h1 class="display-3 mb-1">Edytuj wpis</h1>
          <p class="text-muted mb-0">Wprowadź zmiany w artykule i zapisz je, aby zaktualizować treść.</p>
        </div>
        <div class="text-end text-muted small pb-2">
          Utworzono: <strong><%= post.createdAt.toLocaleDateString('pl-PL') %></strong><br>
          Aktualizacja: <strong><%= post.updatedAt.toLocaleDateString('pl-PL') %></strong>
        </div>
      </div>

      <div class="table-container p-4 p-md-5">
        <form id="postForm" class="row g-4" action="/<%= post._id %>?_method=PUT" enctype="multipart/form-data" method="POST">
          <div class="col-md-8">
            <label for="title" class="form-label">Tytuł artykułu</label>
            <input type="text" class="form-control form-control-lg" id="title" name="title" value="<%= post.title %>" required />
          </div>
          <div class="col-md-4">
            <label for="category" class="form-label">Kategoria</label>
            <select class="form-select form-select-lg" name="category" id="category">
              <option value="Ogólne" <%= post.category === 'Ogólne' ? 'selected' : '' %>>Ogólne</option>
              <option value="Technologia" <%= post.category === 'Technologia' ? 'selected' : '' %>>Technologia</option>
              <option value="Lifestyle" <%= post.category === 'Lifestyle' ? 'selected' : '' %>>Lifestyle</option>
              <option value="Biznes" <%= post.category === 'Biznes' ? 'selected' : '' %>>Biznes</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label for="author" class="form-label">Autor</label>
            <div class="input-group input-group-lg">
              <span class="input-group-text border-end-0"><i class="fa-regular fa-user"></i></span>
              <input type="text" class="form-control border-start-0" id="author" name="author" value="<%= post.author %>" required />
            </div>
          </div>
          <div class="col-md-6">
            <label for="status" class="form-label">Status publikacji</label>
            <select class="form-select form-select-lg" name="status" id="status">
              <option value="Opublikowano" <%= post.status === 'Opublikowano' ? 'selected' : '' %>>Opublikowano</option>
              <option value="Szkic" <%= post.status === 'Szkic' ? 'selected' : '' %>>Szkic (ukryty)</option>
            </select>
          </div>

          <div class="col-12">
            <label class="form-label">Treść posta</label>
            <div id="editor-container" style="height: 400px; background: var(--input-bg); border-radius: 0.5rem;">
              <%- post.content %>
            </div>
            <input type="hidden" name="content" id="content">
          </div>

          <div class="col-md-6">
            <label for="image" class="form-label">Zmień obraz</label>
            <div class="input-group">
              <input class="form-control" type="file" name="image" id="image" accept="image/*" />
              <label class="input-group-text border-start-0" for="image"><i class="fa-solid fa-image me-1"></i> Wybierz</label>
            </div>
          </div>

          <div class="col-md-6">
            <div id="image-preview-container">
              <label class="form-label">Aktualny obraz / Podgląd</label>
              <div class="position-relative d-inline-block d-block">
                <img id="image-preview" src="<%= post.image ? '/uploads/' + post.image : '#' %>" alt="Podgląd" class="img-thumbnail <%= post.image ? '' : 'd-none' %>" style="max-height: 150px;">
                <button type="button" id="remove-image" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 rounded-circle <%= post.image ? '' : 'd-none' %>" style="width: 25px; height: 25px; padding: 0;">&times;</button>
              </div>
            </div>
          </div>

          <div class="col-12 pt-3">
            <hr class="mb-4 opacity-10">
            <div class="d-flex gap-2 justify-content-end align-items-center">
              <a href="/posts" class="btn btn-outline-secondary btn-lg">Anuluj</a>
              <button type="submit" class="btn btn-primary px-5 btn-lg">
                <i class="fa-solid fa-save me-1"></i> Zaktualizuj wpis
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  var quill = new Quill('#editor-container', {
    modules: {
      toolbar: [
        [{ header: [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote', 'code-block'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['link', 'clean']
      ]
    },
    theme: 'snow'
  });

  var form = document.getElementById('postForm');
  form.addEventListener('submit', function(e) {
    var contentInput = document.querySelector('input[name=content]');
    contentInput.value = quill.root.innerHTML;
  });

  const imageInput = document.getElementById('image');
  const previewContainer = document.getElementById('image-preview-container');
  const previewImage = document.getElementById('image-preview');
  const removeButton = document.getElementById('remove-image');

  imageInput.onchange = evt => {
    const [file] = imageInput.files;
    if (file) {
      previewImage.src = URL.createObjectURL(file);
      previewImage.classList.remove('d-none');
      removeButton.classList.remove('d-none');
    }
  };

  removeButton.onclick = () => {
    imageInput.value = "";
    previewImage.src = "#";
    previewImage.classList.add('d-none');
    removeButton.classList.add('d-none');
  };
</script>